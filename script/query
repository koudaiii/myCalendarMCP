#!/bin/bash
set -e

# Usage function
usage() {
    echo "ä½¿ç”¨æ–¹æ³•: $0 [ã‚ªãƒ—ã‚·ãƒ§ãƒ³] \"ã‚¯ã‚¨ãƒª\""
    echo ""
    echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
    echo "  -d, --days N     Næ—¥å¾Œã¾ã§ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 7)"
    echo "  -c, --calendar   ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åã‚’æŒ‡å®š"
    echo "  -l, --list       åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º"
    echo "  -h, --help       ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
    echo ""
    echo "ä¾‹:"
    echo "  $0 \"ç›´è¿‘ã®ä¸€è¦§ã‚’æ•™ãˆã¦\""
    echo "  $0 -d 3 \"ä»Šæ—¥ã‹ã‚‰3æ—¥é–“ã®ã‚¤ãƒ™ãƒ³ãƒˆ\""
    echo "  $0 -c \"ä»•äº‹\" \"ä»•äº‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ\""
    echo "  $0 -l \"ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º\""
}

# Default values
DAYS=7
CALENDAR_NAME=""
QUERY=""
LIST_CALENDARS=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--days)
            DAYS="$2"
            shift 2
            ;;
        -c|--calendar)
            CALENDAR_NAME="$2"
            shift 2
            ;;
        -l|--list)
            LIST_CALENDARS=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            QUERY="$1"
            shift
            ;;
    esac
done

if [[ "$LIST_CALENDARS" == false && -z "$QUERY" ]]; then
    echo "âŒ ã‚¯ã‚¨ãƒªãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
    usage
    exit 1
fi

echo "ğŸ—“ï¸  macOS Calendar ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œä¸­..."
echo "ğŸ“… ã‚¯ã‚¨ãƒª: $QUERY"

# Check if uv is installed
if ! command -v uv &> /dev/null; then
    echo "âŒ uv ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo "ğŸ“¦ ./script/setup ã‚’å®Ÿè¡Œã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„"
    exit 1
fi

# Change to project directory
cd "$(dirname "$0")/.."

# Calculate dates
START_DATE=$(date +"%Y-%m-%d")
END_DATE=$(date -d "+${DAYS} days" +"%Y-%m-%d" 2>/dev/null || date -v+${DAYS}d +"%Y-%m-%d")

echo "ğŸ“ æœŸé–“: $START_DATE ã‹ã‚‰ $END_DATE"
if [[ -n "$CALENDAR_NAME" ]]; then
    echo "ğŸ“‹ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: $CALENDAR_NAME"
fi

# Execute Python script
if [[ "$LIST_CALENDARS" == true ]]; then
    # List calendars
    uv run python -c "
import asyncio
import sys
from calendar_mcp.server import CalendarMCPServer

async def main():
    server = CalendarMCPServer()

    # Get calendars
    calendars = await server._get_calendars()

    if not calendars:
        print('ğŸ“­ åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“')
        return

    if isinstance(calendars, list) and len(calendars) == 1 and 'error' in calendars[0]:
        print(f'âŒ ã‚¨ãƒ©ãƒ¼: {calendars[0][\"error\"]}')
        return

    print(f'\\nğŸ“‹ {len(calendars)}å€‹ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒåˆ©ç”¨å¯èƒ½ã§ã™:\\n')

    for i, calendar in enumerate(calendars, 1):
        title = calendar.get('title', 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—')
        calendar_type = calendar.get('type', 'N/A')
        identifier = calendar.get('identifier', 'N/A')
        modifiable = calendar.get('allowsContentModifications', False)

        print(f'{i}. {title}')
        print(f'   ğŸ·ï¸  ã‚¿ã‚¤ãƒ—: {calendar_type}')
        print(f'   ğŸ†” ID: {identifier}')
        print(f'   âœï¸  ç·¨é›†å¯èƒ½: {\"ã¯ã„\" if modifiable else \"ã„ã„ãˆ\"}')
        print()

if __name__ == '__main__':
    asyncio.run(main())
"
else
    # Get events
    uv run python -c "
import asyncio
import sys
from datetime import datetime
from calendar_mcp.server import CalendarMCPServer

async def main():
    server = CalendarMCPServer()

    # Get events
    events = await server._get_events(
        start_date='$START_DATE',
        end_date='$END_DATE',
        calendar_name='$CALENDAR_NAME' if '$CALENDAR_NAME' else None
    )

    if not events:
        print('ğŸ“­ æŒ‡å®šã—ãŸæœŸé–“ã«ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“')
        return

    if isinstance(events, list) and len(events) == 1 and 'error' in events[0]:
        print(f'âŒ ã‚¨ãƒ©ãƒ¼: {events[0][\"error\"]}')
        return

    print(f'\\nğŸ“‹ {len(events)}ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:\\n')

    for i, event in enumerate(events, 1):
        title = event.get('title', 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—')
        start = event.get('start_date', 'N/A')
        end = event.get('end_date', 'N/A')
        calendar = event.get('calendar', 'N/A')
        notes = event.get('notes', '')

        print(f'{i}. {title}')
        print(f'   ğŸ“… é–‹å§‹: {start}')
        print(f'   ğŸ çµ‚äº†: {end}')
        print(f'   ğŸ“‹ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: {calendar}')
        if notes:
            print(f'   ğŸ“ ãƒ¡ãƒ¢: {notes}')
        print()

if __name__ == '__main__':
    asyncio.run(main())
"
fi