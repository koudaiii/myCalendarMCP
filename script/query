#!/bin/bash
set -e

# Usage function
usage() {
    echo "ä½¿ç”¨æ–¹æ³•: $0 [ã‚ªãƒ—ã‚·ãƒ§ãƒ³] \"ã‚¯ã‚¨ãƒª\""
    echo ""
    echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
    echo "  -d, --days N     Næ—¥å¾Œã¾ã§ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 7)"
    echo "  -c, --calendar   ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åã‚’æŒ‡å®š"
    echo "  -l, --list       åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º"
    echo "  --verbose        è©³ç´°ãƒ­ã‚°ã‚’å‡ºåŠ›"
    echo "  -h, --help       ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
    echo ""
    echo "ä¾‹:"
    echo "  $0 \"ç›´è¿‘ã®ä¸€è¦§ã‚’æ•™ãˆã¦\""
    echo "  $0 -d 3 \"ä»Šæ—¥ã‹ã‚‰3æ—¥é–“ã®ã‚¤ãƒ™ãƒ³ãƒˆ\""
    echo "  $0 -c \"ä»•äº‹\" \"ä»•äº‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ\""
    echo "  $0 -l \"ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º\""
    echo "  $0 --verbose \"è©³ç´°ãƒ­ã‚°ä»˜ãã§ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—\""
}

# Default values
DAYS=7
CALENDAR_NAME=""
QUERY=""
LIST_CALENDARS=false
VERBOSE=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--days)
            DAYS="$2"
            shift 2
            ;;
        -c|--calendar)
            CALENDAR_NAME="$2"
            shift 2
            ;;
        -l|--list)
            LIST_CALENDARS=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            QUERY="$1"
            shift
            ;;
    esac
done

if [[ "$LIST_CALENDARS" == false && -z "$QUERY" ]]; then
    echo "âŒ ã‚¯ã‚¨ãƒªãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
    usage
    exit 1
fi

echo "ğŸ—“ï¸  macOS Calendar ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œä¸­..."
if [[ "$VERBOSE" == true ]]; then
    echo "ğŸ“‹ å®Ÿè¡Œæ–¹æ³•: script/query (ç›´æ¥å‘¼ã³å‡ºã—) - docs/05-call-methods-comparison.md#1"
fi
echo "ğŸ“… ã‚¯ã‚¨ãƒª: $QUERY"

# Check if uv is installed
if ! command -v uv &> /dev/null; then
    echo "âŒ uv ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo "ğŸ“¦ ./script/setup ã‚’å®Ÿè¡Œã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„"
    exit 1
fi

# Change to project directory
cd "$(dirname "$0")/.."

# Calculate dates
START_DATE=$(date +"%Y-%m-%d")
END_DATE=$(date -d "+${DAYS} days" +"%Y-%m-%d" 2>/dev/null || date -v+${DAYS}d +"%Y-%m-%d")

echo "ğŸ“ æœŸé–“: $START_DATE ã‹ã‚‰ $END_DATE"
if [[ -n "$CALENDAR_NAME" ]]; then
    echo "ğŸ“‹ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: $CALENDAR_NAME"
fi
echo ""
if [[ "$VERBOSE" == true ]]; then
    echo "ğŸ”§ CLIENT SIDE: ç›´æ¥å†…éƒ¨ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã— (MCPãƒ—ãƒ­ãƒˆã‚³ãƒ«å±¤ãƒã‚¤ãƒ‘ã‚¹)"
fi

# Execute Python script
if [[ "$LIST_CALENDARS" == true ]]; then
    # List calendars
    if [[ "$VERBOSE" == true ]]; then
        echo "ğŸ“ CLIENT SIDE: CalendarMCPServer()._get_calendars() ã‚’ç›´æ¥å®Ÿè¡Œä¸­..."
    fi
    VERBOSE_MODE=$VERBOSE uv run python -c "
import asyncio
import sys
import logging
from calendar_mcp.server import CalendarMCPServer

# ãƒ­ã‚¬ãƒ¼è¨­å®š
logging.basicConfig(level=logging.INFO, format='%(message)s')
logger = logging.getLogger(__name__)

# Verbose ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š (ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—)
import os
verbose = os.getenv('VERBOSE_MODE', 'false') == 'true'

async def main():
    if verbose:
        logger.info('âš™ï¸  SERVER SIDE: CalendarMCPServer åˆæœŸåŒ–ä¸­...')
    server = CalendarMCPServer()

    # Get calendars
    if verbose:
        logger.info('ğŸ” SERVER SIDE: EventKit ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...')
    calendars = await server._get_calendars()
    if verbose:
        logger.info(f'âœ… SERVER SIDE: {len(calendars) if calendars else 0} å€‹ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å–å¾—å®Œäº†')

    if not calendars:
        logger.info('ğŸ“­ åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“')
        return

    if isinstance(calendars, list) and len(calendars) == 1 and 'error' in calendars[0]:
        logger.error(f'âŒ ã‚¨ãƒ©ãƒ¼: {calendars[0][\"error\"]}')
        return

    if verbose:
        import json
        logger.info(f'\\nğŸ” SERVER SIDE: Raw Response Structure:')
        logger.info(json.dumps(calendars, indent=2, ensure_ascii=False))
        logger.info(f'\\nğŸ“Š CLIENT SIDE: å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›ä¸­...')

    # CLIENT SIDE: æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
    client_response = []
    for calendar in calendars:
        client_response.append({
            'title': calendar.get('title', 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'),
            'type': calendar.get('type', 'N/A'),
            'identifier': calendar.get('identifier', 'N/A'),
            'allowsContentModifications': calendar.get('allowsContentModifications', False)
        })

    if verbose:
        logger.info(f'\\nğŸ” CLIENT SIDE: Formatted Response Structure:')
        logger.info(json.dumps(client_response, indent=2, ensure_ascii=False))

    logger.info(f'ğŸ“‹ {len(calendars)}å€‹ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒåˆ©ç”¨å¯èƒ½ã§ã™:\\n')

    for i, calendar in enumerate(calendars, 1):
        title = calendar.get('title', 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—')
        calendar_type = calendar.get('type', 'N/A')
        identifier = calendar.get('identifier', 'N/A')
        modifiable = calendar.get('allowsContentModifications', False)

        logger.info(f'{i}. {title}')
        logger.info(f'   ğŸ·ï¸  ã‚¿ã‚¤ãƒ—: {calendar_type}')
        logger.info(f'   ğŸ†” ID: {identifier}')
        logger.info(f'   âœï¸  ç·¨é›†å¯èƒ½: {\"ã¯ã„\" if modifiable else \"ã„ã„ãˆ\"}')
        logger.info('')

if __name__ == '__main__':
    asyncio.run(main())
"
else
    # Get events
    if [[ "$VERBOSE" == true ]]; then
        echo "ğŸ“ CLIENT SIDE: CalendarMCPServer()._get_events() ã‚’ç›´æ¥å®Ÿè¡Œä¸­..."
    fi
    VERBOSE_MODE=$VERBOSE uv run python -c "
import asyncio
import sys
import logging
from datetime import datetime
from calendar_mcp.server import CalendarMCPServer

# ãƒ­ã‚¬ãƒ¼è¨­å®š
logging.basicConfig(level=logging.INFO, format='%(message)s')
logger = logging.getLogger(__name__)

# Verbose ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š (ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—)
import os
verbose = os.getenv('VERBOSE_MODE', 'false') == 'true'

async def main():
    if verbose:
        logger.info('âš™ï¸  SERVER SIDE: CalendarMCPServer åˆæœŸåŒ–ä¸­...')
    server = CalendarMCPServer()

    # Get events
    if verbose:
        logger.info('ğŸ” SERVER SIDE: EventKit ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...')
    events = await server._get_events(
        start_date='$START_DATE',
        end_date='$END_DATE',
        calendar_name='$CALENDAR_NAME' if '$CALENDAR_NAME' else None
    )
    if verbose:
        logger.info(f'âœ… SERVER SIDE: {len(events) if events else 0} å€‹ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—å®Œäº†')

    if not events:
        logger.info('ğŸ“­ æŒ‡å®šã—ãŸæœŸé–“ã«ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“')
        return

    if isinstance(events, list) and len(events) == 1 and 'error' in events[0]:
        logger.error(f'âŒ ã‚¨ãƒ©ãƒ¼: {events[0][\"error\"]}')
        return

    if verbose:
        import json
        logger.info(f'\\nğŸ” SERVER SIDE: Raw Response Structure:')
        logger.info(json.dumps(events, indent=2, ensure_ascii=False))
        logger.info(f'\\nğŸ“Š CLIENT SIDE: å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›ä¸­...')

    # CLIENT SIDE: æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
    client_response = []
    for event in events:
        client_response.append({
            'title': event.get('title', 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'),
            'start_date': event.get('start_date', event.get('start', 'N/A')),
            'end_date': event.get('end_date', event.get('end', 'N/A')),
            'calendar': event.get('calendar', 'N/A'),
            'notes': event.get('notes', ''),
            'allDay': event.get('allDay', False)
        })

    if verbose:
        logger.info(f'\\nğŸ” CLIENT SIDE: Formatted Response Structure:')
        logger.info(json.dumps(client_response, indent=2, ensure_ascii=False))

    logger.info(f'ğŸ“‹ {len(events)}ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:\\n')

    for i, event in enumerate(events, 1):
        title = event.get('title', 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—')
        start = event.get('start_date', 'N/A')
        end = event.get('end_date', 'N/A')
        calendar = event.get('calendar', 'N/A')
        notes = event.get('notes', '')

        logger.info(f'{i}. {title}')
        logger.info(f'   ğŸ“… é–‹å§‹: {start}')
        logger.info(f'   ğŸ çµ‚äº†: {end}')
        logger.info(f'   ğŸ“‹ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: {calendar}')
        if notes:
            logger.info(f'   ğŸ“ ãƒ¡ãƒ¢: {notes}')
        logger.info('')

if __name__ == '__main__':
    asyncio.run(main())
"
fi